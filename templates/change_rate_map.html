{% extends "base.html" %}

{% block extra_css %}
<style>
    .map-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px;
    }
    
    .controls-panel {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
    }
    
    .year-selector {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .year-selector label {
        font-size: 18px;
        font-weight: 600;
    }
    
    .year-selector select {
        padding: 8px 20px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: white;
        color: #333;
        min-width: 120px;
    }
    
    .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
    }
    
    .stat-card.increase {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
    }
    
    .stat-card.decrease {
        background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    #changeRateMap {
        width: 100%;
        height: 650px;
        margin: 20px 0;
    }
    
    .legend-panel {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .legend-panel h3 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .legend-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
    
    .legend-section h4 {
        margin-bottom: 10px;
        color: #666;
        font-size: 16px;
    }
    
    .city-rank-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .city-rank-item.increase {
        border-left-color: #ff6b6b;
    }
    
    .city-rank-item.decrease {
        border-left-color: #51cf66;
    }
    
    .change-value {
        font-weight: bold;
    }
    
    .change-value.positive {
        color: #ff6b6b;
    }
    
    .change-value.negative {
        color: #51cf66;
    }
    
    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="controls-panel">
        <div class="year-selector">
            <label>üìÖ Select Year:</label>
            <select id="yearSelect">
                <option value="">Loading...</option>
            </select>
        </div>
        <div style="font-size: 14px; opacity: 0.9;">
            üî¥ Red = Price Increase | üü¢ Green = Price Decrease
        </div>
    </div>

    <div class="stats-panel">
        <div class="stat-card increase">
            <div class="stat-label">Highest Increase</div>
            <div class="stat-value" id="maxIncrease">-</div>
        </div>
        <div class="stat-card decrease">
            <div class="stat-label">Largest Decrease</div>
            <div class="stat-value" id="maxDecrease">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Change</div>
            <div class="stat-value" id="avgChange">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Provinces</div>
            <div class="stat-value" id="totalCities">-</div>
        </div>
    </div>

    <div id="changeRateMap" style="position: relative;">
        <div class="loading-overlay">üîÑ Loading...</div>
    </div>

    <div class="legend-panel">
        <h3>üìä Year-over-Year Change Rankings</h3>
        <div class="legend-grid">
            <div class="legend-section">
                <h4>üî¥ TOP 5 Increases</h4>
                <div id="topIncreasesList">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        Please select a year to view data
                    </div>
                </div>
            </div>
            <div class="legend-section">
                <h4>üü¢ TOP 5 Decreases</h4>
                <div id="topDecreasesList">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        Please select a year to view data
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // ÂüéÂ∏ÇÂêçÊò†Â∞ÑË°®ÔºàËã±ÊñáÂüéÂ∏ÇÂà∞‰∏≠ÊñáÁúÅÂêçÂíåËã±ÊñáÁúÅÂêçÔºâ
    const cityToProvince = {
        "beijing": { province: "Âåó‰∫¨Â∏Ç", provinceEN: "Beijing", cityNameEN: "Beijing" },
        "shanghai": { province: "‰∏äÊµ∑Â∏Ç", provinceEN: "Shanghai", cityNameEN: "Shanghai" },
        "tianjin": { province: "Â§©Ê¥•Â∏Ç", provinceEN: "Tianjin", cityNameEN: "Tianjin" },
        "chongqing": { province: "ÈáçÂ∫ÜÂ∏Ç", provinceEN: "Chongqing", cityNameEN: "Chongqing" },
        "shijiazhuang": { province: "Ê≤≥ÂåóÁúÅ", provinceEN: "Hebei", cityNameEN: "Shijiazhuang" },
        "taiyuan": { province: "Â±±Ë•øÁúÅ", provinceEN: "Shanxi", cityNameEN: "Taiyuan" },
        "hohhot": { province: "ÂÜÖËíôÂè§Ëá™Ê≤ªÂå∫", provinceEN: "Inner Mongolia", cityNameEN: "Hohhot" },
        "shenyang": { province: "ËæΩÂÆÅÁúÅ", provinceEN: "Liaoning", cityNameEN: "Shenyang" },
        "changchun": { province: "ÂêâÊûóÁúÅ", provinceEN: "Jilin", cityNameEN: "Changchun" },
        "harbin": { province: "ÈªëÈæôÊ±üÁúÅ", provinceEN: "Heilongjiang", cityNameEN: "Harbin" },
        "nanjing": { province: "Ê±üËãèÁúÅ", provinceEN: "Jiangsu", cityNameEN: "Nanjing" },
        "hangzhou": { province: "ÊµôÊ±üÁúÅ", provinceEN: "Zhejiang", cityNameEN: "Hangzhou" },
        "hefei": { province: "ÂÆâÂæΩÁúÅ", provinceEN: "Anhui", cityNameEN: "Hefei" },
        "fuzhou": { province: "Á¶èÂª∫ÁúÅ", provinceEN: "Fujian", cityNameEN: "Fuzhou" },
        "nanchang": { province: "Ê±üË•øÁúÅ", provinceEN: "Jiangxi", cityNameEN: "Nanchang" },
        "jinan": { province: "Â±±‰∏úÁúÅ", provinceEN: "Shandong", cityNameEN: "Jinan" },
        "zhengzhou": { province: "Ê≤≥ÂçóÁúÅ", provinceEN: "Henan", cityNameEN: "Zhengzhou" },
        "wuhan": { province: "ÊπñÂåóÁúÅ", provinceEN: "Hubei", cityNameEN: "Wuhan" },
        "changsha": { province: "ÊπñÂçóÁúÅ", provinceEN: "Hunan", cityNameEN: "Changsha" },
        "guangzhou": { province: "Âπø‰∏úÁúÅ", provinceEN: "Guangdong", cityNameEN: "Guangzhou" },
        "nanning": { province: "ÂπøË•øÂ£ÆÊóèËá™Ê≤ªÂå∫", provinceEN: "Guangxi", cityNameEN: "Nanning" },
        "haikou": { province: "Êµ∑ÂçóÁúÅ", provinceEN: "Hainan", cityNameEN: "Haikou" },
        "chengdu": { province: "ÂõõÂ∑ùÁúÅ", provinceEN: "Sichuan", cityNameEN: "Chengdu" },
        "guiyang": { province: "Ë¥µÂ∑ûÁúÅ", provinceEN: "Guizhou", cityNameEN: "Guiyang" },
        "kunming": { province: "‰∫ëÂçóÁúÅ", provinceEN: "Yunnan", cityNameEN: "Kunming" },
        "lhasa": { province: "Ë•øËóèËá™Ê≤ªÂå∫", provinceEN: "Tibet", cityNameEN: "Lhasa" },
        "xi'an": { province: "ÈôïË•øÁúÅ", provinceEN: "Shaanxi", cityNameEN: "Xi'an" },
        "lanzhou": { province: "ÁîòËÇÉÁúÅ", provinceEN: "Gansu", cityNameEN: "Lanzhou" },
        "xining": { province: "ÈùíÊµ∑ÁúÅ", provinceEN: "Qinghai", cityNameEN: "Xining" },
        "yinchuan": { province: "ÂÆÅÂ§èÂõûÊóèËá™Ê≤ªÂå∫", provinceEN: "Ningxia", cityNameEN: "Yinchuan" },
        "urumchi": { province: "Êñ∞ÁñÜÁª¥ÂêæÂ∞îËá™Ê≤ªÂå∫", provinceEN: "Xinjiang", cityNameEN: "Urumqi" },
        "taiwan": { province: "Âè∞ÊπæÁúÅ", provinceEN: "Taiwan", cityNameEN: "Taiwan" },
        "macao": { province: "Êæ≥Èó®ÁâπÂà´Ë°åÊîøÂå∫", provinceEN: "Macao", cityNameEN: "Macao"},
        "hong kong": { province: "È¶ôÊ∏ØÁâπÂà´Ë°åÊîøÂå∫", provinceEN: "Hong Kong", cityNameEN: "Hong Kong"}
    };

    let myChart = null;
    let allYears = [];
    let currentYear = null;

    // ÂàùÂßãÂåñÂõæË°®
    function initChart() {
        const chartDom = document.getElementById('changeRateMap');
        myChart = echarts.init(chartDom);
        
        // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
        myChart.showLoading({
            text: 'Loading map data...',
            color: '#667eea'
        });
    }

    // Âä†ËΩΩÂπ¥‰ªΩÂàóË°®
    async function loadYears() {
        try {
            const response = await fetch('/api/change_rate_map_data');
            const result = await response.json();
            
            if (result.success) {
                allYears = result.years;
                currentYear = result.year;
                
                // Â°´ÂÖÖÂπ¥‰ªΩ‰∏ãÊãâÊ°Ü
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '';
                allYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                });
                
                // Âä†ËΩΩÂΩìÂâçÂπ¥‰ªΩÊï∞ÊçÆ
                await loadMapData(currentYear);
            }
        } catch (error) {
            console.error('Failed to load data:', error);
            alert('Failed to load data. Please refresh the page.');
        }
    }

    // Âä†ËΩΩÂú∞ÂõæÊï∞ÊçÆ
    async function loadMapData(year) {
        try {
            const response = await fetch(`/api/change_rate_map_data?year=${year}`);
            const result = await response.json();
            
            if (result.success) {
                // Â∞ÜËã±ÊñáÂüéÂ∏ÇÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÁúÅ‰ªΩÊï∞ÊçÆ
                const provinceData = [];
                const cityDisplayData = [];
                
                result.data.forEach(item => {
                    const cityNameEN = item.name.toLowerCase();
                    const mapping = cityToProvince[cityNameEN];
                    
                    if (mapping) {
                        // Áî®‰∫éÂú∞ÂõæÊòæÁ§∫ÔºàÂøÖÈ°ª‰ΩøÁî®‰∏≠ÊñáÁúÅÂêçÔºâ
                        provinceData.push({
                            name: mapping.province,  // EChartsÈúÄË¶Å‰∏≠ÊñáÁúÅÂêç
                            value: item.value,       // Ê∂®Ë∑åÂπÖ
                            cityNameEN: mapping.cityNameEN,
                            provinceEN: mapping.provinceEN,
                            price: item.price || 0
                        });
                        
                        // Áî®‰∫éÁªüËÆ°ÂíåÊéíÂêçÊòæÁ§∫
                        cityDisplayData.push({
                            name: mapping.cityNameEN,
                            value: item.value,
                            price: item.price || 0
                        });
                    } else {
                        console.warn('Mapping not found for:', cityNameEN);
                    }
                });
                
                // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                updateStats(cityDisplayData);
                
                // Êõ¥Êñ∞ÊéíÂêçÂàóË°®
                updateRankings(cityDisplayData);
                
                // Ê∏≤ÊüìÂú∞Âõæ
                renderMap(provinceData, year);
            } else {
                alert('Failed to load map data: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Failed to load map data:', error);
            alert('Failed to load map data. Please check your internet connection.');
        }
    }

    // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
    function updateStats(data) {
        if (data.length === 0) return;
        
        const changeRates = data.map(item => item.value);
        const maxIncrease = Math.max(...changeRates);
        const maxDecrease = Math.min(...changeRates);
        const avgChange = changeRates.reduce((a, b) => a + b, 0) / changeRates.length;
        
        document.getElementById('maxIncrease').textContent = '+' + maxIncrease.toFixed(2) + '%';
        document.getElementById('maxDecrease').textContent = maxDecrease.toFixed(2) + '%';
        document.getElementById('avgChange').textContent = (avgChange >= 0 ? '+' : '') + avgChange.toFixed(2) + '%';
        document.getElementById('totalCities').textContent = data.length;
    }

    // Êõ¥Êñ∞ÊéíÂêçÂàóË°®
    function updateRankings(data) {
        // Ê∂®ÂπÖÊúÄÂ§ßÁöÑ5‰∏™ÂüéÂ∏Ç
        const topIncreases = [...data]
            .filter(item => item.value > 0)
            .sort((a, b) => b.value - a.value)
            .slice(0, 5);
        
        const increasesHtml = topIncreases.length > 0 ? topIncreases.map((item, index) => `
            <div class="city-rank-item increase">
                <span>${index + 1}. ${item.name}</span>
                <span class="change-value positive">+${item.value.toFixed(2)}%</span>
            </div>
        `).join('') : '<div style="text-align: center; color: #999; padding: 10px;">No increases</div>';
        
        document.getElementById('topIncreasesList').innerHTML = increasesHtml;
        
        // Ë∑åÂπÖÊúÄÂ§ßÁöÑ5‰∏™ÂüéÂ∏Ç
        const topDecreases = [...data]
            .filter(item => item.value < 0)
            .sort((a, b) => a.value - b.value)
            .slice(0, 5);
        
        const decreasesHtml = topDecreases.length > 0 ? topDecreases.map((item, index) => `
            <div class="city-rank-item decrease">
                <span>${index + 1}. ${item.name}</span>
                <span class="change-value negative">${item.value.toFixed(2)}%</span>
            </div>
        `).join('') : '<div style="text-align: center; color: #999; padding: 10px;">No decreases</div>';
        
        document.getElementById('topDecreasesList').innerHTML = decreasesHtml;
    }

    // Ê∏≤ÊüìÂú∞Âõæ
    function renderMap(data, year) {
        myChart.hideLoading();
        
        const option = {
            title: {
                text: `China Housing Price YoY Change Rate Map (${year})`,
                left: 'center',
                top: 20,
                textStyle: {
                    fontSize: 24,
                    fontWeight: 'bold',
                    color: '#333'
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.data && typeof params.data.value !== 'undefined') {
                        const cityName = params.data.cityNameEN;
                        const provinceName = params.data.provinceEN;
                        const changeRate = params.data.value;
                        const price = params.data.price;
                        const changeColor = changeRate >= 0 ? '#ff6b6b' : '#51cf66';
                        const changeSign = changeRate > 0 ? '+' : '';
                        
                        return `
                            <div style="padding: 10px;">
                                <strong style="font-size: 16px;">${cityName}, ${provinceName}</strong><br/>
                                <span style="color: ${changeColor};">üìà YoY Change:</span> <strong style="color: ${changeColor};">${changeSign}${changeRate.toFixed(2)}%</strong><br/>
                                <span style="color: #667eea;">üí∞ Current Price:</span> ¬•${price.toLocaleString()}/m¬≤
                            </div>
                        `;
                    } else {
                        return `<div style="padding: 10px;">${params.name}<br/>No data available</div>`;
                    }
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#667eea',
                borderWidth: 2,
                textStyle: {
                    color: '#333'
                }
            },
            visualMap: {
                show: true,
                left: 'left',
                bottom: 'bottom',
                type: 'piecewise',
                pieces: [
                    {min: 10, label: '‚â• +10%', color: '#8B0000'},
                    {min: 5, max: 9.99, label: '+5% ~ +10%', color: '#DC143C'},
                    {min: 2, max: 4.99, label: '+2% ~ +5%', color: '#FF6B6B'},
                    {min: 0, max: 1.99, label: '0% ~ +2%', color: '#FFA07A'},
                    {min: -2, max: -0.01, label: '-2% ~ 0%', color: '#98FB98'},
                    {min: -5, max: -2.01, label: '-5% ~ -2%', color: '#51CF66'},
                    {min: -10, max: -5.01, label: '-10% ~ -5%', color: '#2E8B57'},
                    {max: -10.01, label: '‚â§ -10%', color: '#006400'}
                ],
                textStyle: {
                    color: '#333',
                    fontSize: 12
                }
            },
            series: [
                {
                    name: 'Change Rate',
                    type: 'map',
                    map: 'china',
                    roam: true,
                    emphasis: {
                        label: {
                            show: false
                        },
                        itemStyle: {
                            areaColor: '#667eea',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    },
                    itemStyle: {
                        areaColor: '#eee',
                        borderColor: '#999',
                        borderWidth: 0.5
                    },
                    label: {
                        show: false
                    },
                    data: data
                }
            ]
        };
        
        myChart.setOption(option, true);
    }

    // Âπ¥‰ªΩÈÄâÊã©‰∫ã‰ª∂
    document.getElementById('yearSelect').addEventListener('change', function(e) {
        const selectedYear = parseInt(e.target.value);
        if (selectedYear) {
            loadMapData(selectedYear);
        }
    });

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', async function() {
        initChart();
        
        // Ê≥®ÂÜå‰∏≠ÂõΩÂú∞Âõæ
        try {
            const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json');
            const chinaJson = await response.json();
            echarts.registerMap('china', chinaJson);
            
            // Âä†ËΩΩÂπ¥‰ªΩÂíåÊï∞ÊçÆ
            await loadYears();
        } catch (error) {
            console.error('Failed to load map:', error);
            myChart.hideLoading();
            alert('Failed to load map. Please check your internet connection.');
        }
    });

    // ÂìçÂ∫îÂºèË∞ÉÊï¥
    window.addEventListener('resize', function() {
        if (myChart) {
            myChart.resize();
        }
    });
</script>
{% endblock %}
```
