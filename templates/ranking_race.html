{% extends "base.html" %}

{% block extra_css %}
<style>
    .race-container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .controls-panel {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        padding: 24px;
        margin-bottom: 24px;
    }

    .controls-panel h3 {
        color: #667eea;
        margin-bottom: 20px;
        font-size: 1.3em;
    }

    .control-group {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .control-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-item label {
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
    }

    .control-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .btn-warning {
        background: #ffc107;
        color: #000;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    input[type="number"] {
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        width: 100px;
        transition: border-color 0.3s;
    }

    input[type="number"]:focus {
        outline: none;
        border-color: #667eea;
    }

    .chart-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        padding: 32px 24px;
        height: 700px;
    }

    #rankingChart {
        width: 100%;
        height: 100%;
    }

    .status-text {
        color: #667eea;
        font-weight: 600;
        font-size: 1.1em;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #667eea;
        font-size: 1.2em;
    }
</style>
{% endblock %}

{% block content %}
<div class="race-container">
    <div class="controls-panel">
        <h3>ğŸ Ranking Race for Housing Price</h3>
        <div class="control-group">
            <button id="startBtn" class="control-btn btn-primary">
                â–¶ Start
            </button>
            <button id="pauseBtn" class="control-btn btn-secondary" disabled>
                â¸ Stop
            </button>
            <button id="resetBtn" class="control-btn btn-warning">
                Restart
            </button>
            
            <div class="control-item">
                <label>Speed (ms):</label>
                <input type="number" id="speedInput" value="1000" min="100" max="5000" step="100">
            </div>
            
            <div class="control-item">
                <label>City number:</label>
                <input type="number" id="topNInput" value="15" min="5" max="50" step="1">
            </div>
            
            <div class="control-item status-text">
                <span id="statusText">Ready</span>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div id="loadingText" class="loading">Loading...</div>
        <div id="rankingChart"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let myChart = null;
let allData = {};
let timePoints = [];
let currentIndex = 0;
let animationTimer = null;
let isPlaying = false;

// åŸå¸‚é¢œè‰²æ˜ å°„ï¼ˆå¯ä»¥è‡ªå®šä¹‰ï¼‰
const cityColors = {};
const colorPalette = [
    '#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de',
    '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#d14a61',
    '#675bba', '#759aa0', '#e69d87', '#8dc1a9', '#dd6b66'
];

// åˆå§‹åŒ–å›¾è¡¨
// åˆå§‹åŒ–å›¾è¡¨
function initChart() {
    const chartDom = document.getElementById('rankingChart');
    myChart = echarts.init(chartDom);
    
    const option = {
        grid: {
            top: 50,
            bottom: 80,
            left: 150,  // å¢åŠ å·¦è¾¹è·ä»¥å®¹çº³åŸå¸‚åç§°
            right: 100
        },
        xAxis: {
            max: 'dataMax',
            axisLabel: {
                formatter: function (n) {
                    return n.toFixed(0) + ' ï¿¥/ã¡';
                }
            }
        },
        yAxis: {
            type: 'category',
            inverse: true,
            max: parseInt(document.getElementById('topNInput').value) - 1,
            // ç§»é™¤åŸæ¥çš„axisLabelé…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®æ˜¾ç¤ºåŸå¸‚åç§°
            axisLabel: {
                fontSize: 12,
                fontWeight: 'bold',
                color: '#333'
            },
            animationDuration: 300,
            animationDurationUpdate: 300,
            data: []  // åˆå§‹ä¸ºç©ºæ•°ç»„ï¼Œåç»­åŠ¨æ€æ›´æ–°
        },
        series: [{
            realtimeSort: true,
            type: 'bar',
            data: [],
            label: {
                show: true,
                position: 'right',
                valueAnimation: true,
                fontFamily: 'monospace',
                fontSize: 14,
                formatter: function(param) {
                    return param.value.toFixed(0);
                }
            },
            itemStyle: {
                color: function(param) {
                    const city = param.name;
                    if (!cityColors[city]) {
                        const colorIndex = Object.keys(cityColors).length % colorPalette.length;
                        cityColors[city] = colorPalette[colorIndex];
                    }
                    return cityColors[city];
                }
            }
        }],
        animationDuration: 0,
        animationDurationUpdate: parseInt(document.getElementById('speedInput').value),
        animationEasing: 'linear',
        animationEasingUpdate: 'linear',
        graphic: {
            elements: [{
                type: 'text',
                right: 100,
                bottom: 20,
                style: {
                    text: '',
                    font: 'bolder 60px monospace',
                    fill: 'rgba(100, 100, 100, 0.25)'
                },
                z: 100
            }]
        }
    };
    
    myChart.setOption(option);
}

// åŠ è½½æ•°æ®
async function loadData() {
    try {
        const response = await fetch('/api/ranking_race_data');
        const result = await response.json();
        
        if (result.success) {
            allData = result.data;
            timePoints = result.timePoints;
            document.getElementById('loadingText').style.display = 'none';
            document.getElementById('rankingChart').style.display = 'block';
            
            initChart();
            updateChart(0);
            document.getElementById('statusText').textContent = `${timePoints.length} months been loaded`;
        } else {
            alert('æ•°æ®åŠ è½½å¤±è´¥: ' + result.message);
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
        alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
}

// æ›´æ–°å›¾è¡¨
function updateChart(index) {
    if (index >= timePoints.length) {
        stopAnimation();
        return;
    }
    
    currentIndex = index;
    const timeKey = timePoints[index];
    const data = allData[timeKey];
    
    if (!data || data.length === 0) return;
    
    // è·å–å½“å‰è¦æ˜¾ç¤ºçš„åŸå¸‚æ•°é‡
    const topN = parseInt(document.getElementById('topNInput').value);
    const topData = data.slice(0, topN);
    
    // å‡†å¤‡å›¾è¡¨æ•°æ® - å…³é”®ä¿®æ”¹ï¼šç¡®ä¿æ•°æ®åŒ…å«åŸå¸‚åç§°
    const chartData = topData.map(item => ({
        name: item.city,
        value: item.price
    }));
    
    // è·å–åŸå¸‚åç§°åˆ—è¡¨ç”¨äºyè½´æ˜¾ç¤º
    const cityNames = topData.map(item => item.city);
    
    // æ›´æ–°å›¾è¡¨é…ç½® - å…³é”®ä¿®æ”¹ï¼šè®¾ç½®yè½´çš„data
    const option = {
        yAxis: {
            data: cityNames,  // æ·»åŠ è¿™è¡Œï¼Œè®¾ç½®yè½´æ˜¾ç¤ºåŸå¸‚åç§°
            max: topN - 1
        },
        series: [{
            data: chartData
        }],
        animationDurationUpdate: parseInt(document.getElementById('speedInput').value),
        graphic: {
            elements: [{
                style: {
                    text: timeKey
                }
            }]
        }
    };
    
    myChart.setOption(option);
    
    // æ›´æ–°çŠ¶æ€æ–‡æœ¬
    document.getElementById('statusText').textContent = 
        `${timeKey} (${index + 1}/${timePoints.length})`;
}

// å¼€å§‹åŠ¨ç”»
function startAnimation() {
    if (isPlaying) return;
    
    isPlaying = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('pauseBtn').disabled = false;
    document.getElementById('statusText').textContent = 'æ’­æ”¾ä¸­...';
    
    const speed = parseInt(document.getElementById('speedInput').value);
    
    function animate() {
        if (!isPlaying) return;
        
        if (currentIndex >= timePoints.length - 1) {
            stopAnimation();
            return;
        }
        
        currentIndex++;
        updateChart(currentIndex);
        
        animationTimer = setTimeout(animate, speed);
    }
    
    animate();
}

// æš‚åœåŠ¨ç”»
function pauseAnimation() {
    isPlaying = false;
    if (animationTimer) {
        clearTimeout(animationTimer);
        animationTimer = null;
    }
    document.getElementById('startBtn').disabled = false;
    document.getElementById('pauseBtn').disabled = true;
    document.getElementById('statusText').textContent = 'Suspended';
}

// åœæ­¢åŠ¨ç”»
function stopAnimation() {
    pauseAnimation();
    document.getElementById('statusText').textContent = 'Complished';
}

// é‡ç½®
function resetAnimation() {
    pauseAnimation();
    currentIndex = 0;
    updateChart(0);
    document.getElementById('statusText').textContent = 'Has refrashed';
}

// äº‹ä»¶ç›‘å¬
document.getElementById('startBtn').addEventListener('click', startAnimation);
document.getElementById('pauseBtn').addEventListener('click', pauseAnimation);
document.getElementById('resetBtn').addEventListener('click', resetAnimation);

// é€Ÿåº¦å’Œæ˜¾ç¤ºæ•°é‡å˜åŒ–æ—¶æ›´æ–°å›¾è¡¨é…ç½®
document.getElementById('speedInput').addEventListener('change', function() {
    if (myChart) {
        myChart.setOption({
            animationDurationUpdate: parseInt(this.value)
        });
    }
});

document.getElementById('topNInput').addEventListener('change', function() {
    updateChart(currentIndex);
});

// çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è¡¨
window.addEventListener('resize', function() {
    if (myChart) {
        myChart.resize();
    }
});

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('load', function() {
    loadData();
});
</script>
{% endblock %}