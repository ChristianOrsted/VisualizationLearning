{% extends "base.html" %}

{% block extra_css %}
<style>
    .map-container {
        background: none;
        border-radius: 0;
        box-shadow: none;
        width: 100%;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
    }
    
    .controls-panel {
        background: linear-gradient(90deg, #e0eaff 0%, #d5ecf6 100%);
        border-radius: 20px;
        box-shadow: 0 4px 18px rgba(120,130,180,0.12);
        padding: 20px 30px;
        margin: 24px 0;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 20px;
    }
    
    .year-selector {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255,255,255,0.40);
        border-radius: 16px;
        padding: 8px 18px 8px 14px;
        box-shadow: 0 1px 8px rgba(150,160,220,0.08);
    }
    
    .year-selector label {
        font-size: 1.12em;
        font-weight: 600;
        color: #3d4d6c;
        letter-spacing: 1px;
        margin-right: 4px;
    }
    
    .year-selector select {
        padding: 6px 18px;
        font-size: 1em;
        border: 1px solid #b1badb;
        border-radius: 10px;
        background: #fff;
        color: #304066;
        transition: border .19s;
        outline: none;
    }
    
    .year-selector select:focus {
        border-color: #667eea;
    }
    
    .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    #priceMap {
        width: 100% !important;
        height: 580px !important;
        min-height: 0;
        background: white;
        border-radius: 20px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        margin: 24px 0;
        padding: 8px;
    }
    
    .top-cities {
        background: #f8f9fa;
        border-radius: 0;
        padding: 20px;
        margin-top: 20px;
    }
    
    .top-cities h3 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .city-rank-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .city-rank-item:nth-child(1) { border-left-color: #FFD700; }
    .city-rank-item:nth-child(2) { border-left-color: #C0C0C0; }
    .city-rank-item:nth-child(3) { border-left-color: #CD7F32; }
    
    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="controls-panel">
        <div class="year-selector">
            <label>üìÖ Select Year:</label>
            <select id="yearSelect">
                <option value="">Loading...</option>
            </select>
        </div>
        <div style="font-size: 14px; opacity: 0.9;">
            üí° Hover over provinces for detailed information
        </div>
    </div>

    <div class="stats-panel">
        <div class="stat-card">
            <div class="stat-label">Highest Price</div>
            <div class="stat-value" id="maxPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Lowest Price</div>
            <div class="stat-value" id="minPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Price</div>
            <div class="stat-value" id="avgPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Provinces</div>
            <div class="stat-value" id="totalCities">-</div>
        </div>
    </div>

    <div id="priceMap" style="position: relative;">
        <div class="loading-overlay">üîÑ Loading...</div>
    </div>

    <div class="top-cities">
        <h3>üèÜ TOP 10 Cities by Housing Price</h3>
        <div id="topCitiesList">
            <div style="text-align: center; color: #999; padding: 20px;">
                Please select a year to view data
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // ÂüéÂ∏ÇÂêçÊò†Â∞ÑË°®ÔºàËã±ÊñáÂüéÂ∏ÇÂà∞‰∏≠ÊñáÁúÅÂêçÂíåËã±ÊñáÁúÅÂêçÔºâ
    const cityToProvince = {
        "beijing": { province: "Âåó‰∫¨Â∏Ç", provinceEN: "Beijing", cityNameEN: "Beijing" },
        "shanghai": { province: "‰∏äÊµ∑Â∏Ç", provinceEN: "Shanghai", cityNameEN: "Shanghai" },
        "tianjin": { province: "Â§©Ê¥•Â∏Ç", provinceEN: "Tianjin", cityNameEN: "Tianjin" },
        "chongqing": { province: "ÈáçÂ∫ÜÂ∏Ç", provinceEN: "Chongqing", cityNameEN: "Chongqing" },
        "shijiazhuang": { province: "Ê≤≥ÂåóÁúÅ", provinceEN: "Hebei", cityNameEN: "Shijiazhuang" },
        "taiyuan": { province: "Â±±Ë•øÁúÅ", provinceEN: "Shanxi", cityNameEN: "Taiyuan" },
        "hohhot": { province: "ÂÜÖËíôÂè§Ëá™Ê≤ªÂå∫", provinceEN: "Inner Mongolia", cityNameEN: "Hohhot" },
        "shenyang": { province: "ËæΩÂÆÅÁúÅ", provinceEN: "Liaoning", cityNameEN: "Shenyang" },
        "changchun": { province: "ÂêâÊûóÁúÅ", provinceEN: "Jilin", cityNameEN: "Changchun" },
        "harbin": { province: "ÈªëÈæôÊ±üÁúÅ", provinceEN: "Heilongjiang", cityNameEN: "Harbin" },
        "nanjing": { province: "Ê±üËãèÁúÅ", provinceEN: "Jiangsu", cityNameEN: "Nanjing" },
        "hangzhou": { province: "ÊµôÊ±üÁúÅ", provinceEN: "Zhejiang", cityNameEN: "Hangzhou" },
        "hefei": { province: "ÂÆâÂæΩÁúÅ", provinceEN: "Anhui", cityNameEN: "Hefei" },
        "fuzhou": { province: "Á¶èÂª∫ÁúÅ", provinceEN: "Fujian", cityNameEN: "Fuzhou" },
        "nanchang": { province: "Ê±üË•øÁúÅ", provinceEN: "Jiangxi", cityNameEN: "Nanchang" },
        "jinan": { province: "Â±±‰∏úÁúÅ", provinceEN: "Shandong", cityNameEN: "Jinan" },
        "zhengzhou": { province: "Ê≤≥ÂçóÁúÅ", provinceEN: "Henan", cityNameEN: "Zhengzhou" },
        "wuhan": { province: "ÊπñÂåóÁúÅ", provinceEN: "Hubei", cityNameEN: "Wuhan" },
        "changsha": { province: "ÊπñÂçóÁúÅ", provinceEN: "Hunan", cityNameEN: "Changsha" },
        "guangzhou": { province: "Âπø‰∏úÁúÅ", provinceEN: "Guangdong", cityNameEN: "Guangzhou" },
        "nanning": { province: "ÂπøË•øÂ£ÆÊóèËá™Ê≤ªÂå∫", provinceEN: "Guangxi", cityNameEN: "Nanning" },
        "haikou": { province: "Êµ∑ÂçóÁúÅ", provinceEN: "Hainan", cityNameEN: "Haikou" },
        "chengdu": { province: "ÂõõÂ∑ùÁúÅ", provinceEN: "Sichuan", cityNameEN: "Chengdu" },
        "guiyang": { province: "Ë¥µÂ∑ûÁúÅ", provinceEN: "Guizhou", cityNameEN: "Guiyang" },
        "kunming": { province: "‰∫ëÂçóÁúÅ", provinceEN: "Yunnan", cityNameEN: "Kunming" },
        "lhasa": { province: "Ë•øËóèËá™Ê≤ªÂå∫", provinceEN: "Tibet", cityNameEN: "Lhasa" },
        "xi'an": { province: "ÈôïË•øÁúÅ", provinceEN: "Shaanxi", cityNameEN: "Xi'an" },
        "lanzhou": { province: "ÁîòËÇÉÁúÅ", provinceEN: "Gansu", cityNameEN: "Lanzhou" },
        "xining": { province: "ÈùíÊµ∑ÁúÅ", provinceEN: "Qinghai", cityNameEN: "Xining" },
        "yinchuan": { province: "ÂÆÅÂ§èÂõûÊóèËá™Ê≤ªÂå∫", provinceEN: "Ningxia", cityNameEN: "Yinchuan" },
        "urumchi": { province: "Êñ∞ÁñÜÁª¥ÂêæÂ∞îËá™Ê≤ªÂå∫", provinceEN: "Xinjiang", cityNameEN: "Urumqi" },
        "taiwan": { province: "Âè∞ÊπæÁúÅ", provinceEN: "Taiwan", cityNameEN: "Taiwan" },
        "macao": { province: "Êæ≥Èó®ÁâπÂà´Ë°åÊîøÂå∫", provinceEN: "Macao", cityNameEN: "Macao"},
        "hong kong": { province: "È¶ôÊ∏ØÁâπÂà´Ë°åÊîøÂå∫", provinceEN: "Hong Kong", cityNameEN: "Hong Kong"}
    };

    let myChart = null;
    let allYears = [];
    let currentYear = null;

    // ÂàùÂßãÂåñÂõæË°®
    function initChart() {
        const chartDom = document.getElementById('priceMap');
        myChart = echarts.init(chartDom);
        
        // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
        myChart.showLoading({
            text: 'Loading map data...',
            color: '#667eea'
        });
    }

    // Âä†ËΩΩÂπ¥‰ªΩÂàóË°®
    async function loadYears() {
        try {
            const response = await fetch('/api/map_data');
            const result = await response.json();
            
            if (result.success) {
                allYears = result.years;
                currentYear = result.year;
                
                // Â°´ÂÖÖÂπ¥‰ªΩ‰∏ãÊãâÊ°Ü
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '';
                allYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                });
                
                // Âä†ËΩΩÂΩìÂâçÂπ¥‰ªΩÊï∞ÊçÆ
                await loadMapData(currentYear);
            }
        } catch (error) {
            console.error('Failed to load data:', error);
            alert('Failed to load data. Please refresh the page.');
        }
    }

    // Âä†ËΩΩÂú∞ÂõæÊï∞ÊçÆ
    async function loadMapData(year) {
        try {
            const response = await fetch(`/api/map_data?year=${year}`);
            const result = await response.json();
            
            if (result.success) {
                // Â∞ÜËã±ÊñáÂüéÂ∏ÇÊï∞ÊçÆËΩ¨Êç¢‰∏∫ÁúÅ‰ªΩÊï∞ÊçÆ
                const provinceData = [];
                const cityDisplayData = [];
                
                result.data.forEach(item => {
                    const cityNameEN = item.name.toLowerCase();
                    const mapping = cityToProvince[cityNameEN];
                    
                    if (mapping) {
                        // Áî®‰∫éÂú∞ÂõæÊòæÁ§∫ÔºàÂøÖÈ°ª‰ΩøÁî®‰∏≠ÊñáÁúÅÂêçÔºâ
                        provinceData.push({
                            name: mapping.province,  // EChartsÈúÄË¶Å‰∏≠ÊñáÁúÅÂêç
                            value: item.value,
                            cityNameEN: mapping.cityNameEN,  // Ëã±ÊñáÂüéÂ∏ÇÂêç
                            provinceEN: mapping.provinceEN,  // Ëã±ÊñáÁúÅÂêç
                            changeRate: item.changeRate || 0
                        });
                        
                        // Áî®‰∫éÁªüËÆ°ÂíåÊéíÂêçÊòæÁ§∫ÔºàÁ∫ØËã±ÊñáÔºâ
                        cityDisplayData.push({
                            name: mapping.cityNameEN,
                            value: item.value,
                            changeRate: item.changeRate || 0
                        });
                    } else {
                        console.warn('Mapping not found for:', cityNameEN);
                    }
                });
                
                // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                updateStats(cityDisplayData);
                
                // Êõ¥Êñ∞TOP10ÂàóË°®
                updateTopCities(cityDisplayData);
                
                // Ê∏≤ÊüìÂú∞Âõæ
                renderMap(provinceData, year);
            } else {
                alert('Failed to load map data: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Failed to load map data:', error);
            alert('Failed to load map data. Please check your internet connection.');
        }
    }

    // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
    function updateStats(data) {
        if (data.length === 0) return;
        
        const prices = data.map(item => item.value);
        const maxPrice = Math.max(...prices);
        const minPrice = Math.min(...prices);
        const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
        
        document.getElementById('maxPrice').textContent = '¬•' + maxPrice.toLocaleString();
        document.getElementById('minPrice').textContent = '¬•' + minPrice.toLocaleString();
        document.getElementById('avgPrice').textContent = '¬•' + Math.round(avgPrice).toLocaleString();
        document.getElementById('totalCities').textContent = data.length;
    }

    // Êõ¥Êñ∞TOP10ÂüéÂ∏ÇÂàóË°®
    function updateTopCities(data) {
        const sorted = [...data].sort((a, b) => b.value - a.value).slice(0, 10);
        const listHtml = sorted.map((item, index) => `
            <div class="city-rank-item">
                <span>${index + 1}. ${item.name}</span>
                <strong>¬•${item.value.toLocaleString()}</strong>
            </div>
        `).join('');
        
        document.getElementById('topCitiesList').innerHTML = listHtml;
    }

    // Ê∏≤ÊüìÂú∞Âõæ
    function renderMap(data, year) {
        myChart.hideLoading();
        
        const option = {
            title: {
                text: `China Housing Price Distribution Heat Map (${year})`,
                left: 'center',
                top: 20,
                textStyle: {
                    fontSize: 24,
                    fontWeight: 'bold',
                    color: '#333'
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.data && params.data.value) {
                        const cityName = params.data.cityNameEN;
                        const provinceName = params.data.provinceEN;
                        const price = params.data.value;
                        const changeRate = params.data.changeRate || 0;
                        const changeColor = changeRate >= 0 ? '#ff4444' : '#00cc00';
                        const changeSign = changeRate > 0 ? '+' : '';
                        
                        return `
                            <div style="padding: 10px;">
                                <strong style="font-size: 16px;">${cityName}, ${provinceName}</strong><br/>
                                <span style="color: #667eea;">üí∞ Price:</span> ¬•${price.toLocaleString()}/m¬≤<br/>
                                <span style="color: ${changeColor};">üìà YoY Change:</span> ${changeSign}${changeRate}%
                            </div>
                        `;
                    } else {
                        return `<div style="padding: 10px;">${params.name}<br/>No data available</div>`;
                    }
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#667eea',
                borderWidth: 2,
                textStyle: {
                    color: '#333'
                }
            },
            visualMap: {
                show: true,
                left: 'left',
                bottom: 'bottom',
                type: 'piecewise',
                pieces: [
                    {min: 100000, label: '‚â• ¬•100,000', color: '#67001f'},
                    {min: 50000, max: 99999, label: '¬•50,000 - ¬•99,999', color: '#b2182b'},
                    {min: 30000, max: 49999, label: '¬•30,000 - ¬•49,999', color: '#d6604d'},
                    {min: 20000, max: 29999, label: '¬•20,000 - ¬•29,999', color: '#f4a582'},
                    {min: 15000, max: 19999, label: '¬•15,000 - ¬•19,999', color: '#fddbc7'},
                    {min: 10000, max: 14999, label: '¬•10,000 - ¬•14,999', color: '#d1e5f0'},
                    {min: 8000, max: 9999, label: '¬•8,000 - ¬•9,999', color: '#92c5de'},
                    {min: 6000, max: 7999, label: '¬•6,000 - ¬•7,999', color: '#4393c3'},
                    {min: 4000, max: 5999, label: '¬•4,000 - ¬•5,999', color: '#2166ac'},
                    {max: 3999, label: '< ¬•4,000', color: '#053061'}
                ],
                textStyle: {
                    color: '#333',
                    fontSize: 12
                }
            },
            series: [
                {
                    name: 'Housing Price',
                    type: 'map',
                    map: 'china',
                    roam: true,
                    emphasis: {
                        label: {
                            show: false  // ÊÇ¨ÂÅúÊó∂‰πü‰∏çÊòæÁ§∫ÁúÅÂêç
                        },
                        itemStyle: {
                            areaColor: '#667eea',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    },
                    itemStyle: {
                        areaColor: '#eee',
                        borderColor: '#999',
                        borderWidth: 0.5
                    },
                    label: {
                        show: false  // ‰∏çÊòæÁ§∫ÁúÅÂêç
                    },
                    data: data
                }
            ]
        };
        
        myChart.setOption(option, true);
    }

    // Âπ¥‰ªΩÈÄâÊã©‰∫ã‰ª∂
    document.getElementById('yearSelect').addEventListener('change', function(e) {
        const selectedYear = parseInt(e.target.value);
        if (selectedYear) {
            loadMapData(selectedYear);
        }
    });

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', async function() {
        initChart();
        
        // Ê≥®ÂÜå‰∏≠ÂõΩÂú∞Âõæ
        try {
            const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json');
            const chinaJson = await response.json();
            echarts.registerMap('china', chinaJson);
            
            // Âä†ËΩΩÂπ¥‰ªΩÂíåÊï∞ÊçÆ
            await loadYears();
        } catch (error) {
            console.error('Failed to load map:', error);
            myChart.hideLoading();
            alert('Failed to load map. Please check your internet connection.');
        }
    });

    // ÂìçÂ∫îÂºèË∞ÉÊï¥
    window.addEventListener('resize', function() {
        if (myChart) {
            myChart.resize();
        }
    });
</script>
{% endblock %}