{% extends "base.html" %}

{% block extra_css %}
<style>
    .map-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin: 20px;
    }
    
    .controls-panel {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        color: white;
    }
    
    .year-selector {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .year-selector label {
        font-size: 18px;
        font-weight: 600;
    }
    
    .year-selector select {
        padding: 8px 20px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: white;
        color: #333;
        min-width: 120px;
    }
    
    .stats-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    #priceMap {
        width: 100%;
        height: 650px;
        margin: 20px 0;
    }
    
    .top-cities {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .top-cities h3 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .city-rank-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        margin-bottom: 8px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }
    
    .city-rank-item:nth-child(1) { border-left-color: #FFD700; }
    .city-rank-item:nth-child(2) { border-left-color: #C0C0C0; }
    .city-rank-item:nth-child(3) { border-left-color: #CD7F32; }
    
    .loading-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 18px;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="controls-panel">
        <div class="year-selector">
            <label>ğŸ“… Select Year:</label>
            <select id="yearSelect">
                <option value="">Loading...</option>
            </select>
        </div>
        <div style="font-size: 14px; opacity: 0.9;">
            ğŸ’¡ Hover over provinces for detailed information
        </div>
    </div>

    <div class="stats-panel">
        <div class="stat-card">
            <div class="stat-label">Highest Price</div>
            <div class="stat-value" id="maxPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Lowest Price</div>
            <div class="stat-value" id="minPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Price</div>
            <div class="stat-value" id="avgPrice">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Provinces</div>
            <div class="stat-value" id="totalCities">-</div>
        </div>
    </div>

    <div id="priceMap" style="position: relative;">
        <div class="loading-overlay">ğŸ”„ Loading...</div>
    </div>

    <div class="top-cities">
        <h3>ğŸ† TOP 10 Cities by Housing Price</h3>
        <div id="topCitiesList">
            <div style="text-align: center; color: #999; padding: 20px;">
                Please select a year to view data
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    // åŸå¸‚åæ˜ å°„è¡¨ï¼ˆè‹±æ–‡åŸå¸‚åˆ°ä¸­æ–‡çœåå’Œè‹±æ–‡çœåï¼‰
    const cityToProvince = {
        "beijing": { province: "åŒ—äº¬å¸‚", provinceEN: "Beijing", cityNameEN: "Beijing" },
        "shanghai": { province: "ä¸Šæµ·å¸‚", provinceEN: "Shanghai", cityNameEN: "Shanghai" },
        "tianjin": { province: "å¤©æ´¥å¸‚", provinceEN: "Tianjin", cityNameEN: "Tianjin" },
        "chongqing": { province: "é‡åº†å¸‚", provinceEN: "Chongqing", cityNameEN: "Chongqing" },
        "shijiazhuang": { province: "æ²³åŒ—çœ", provinceEN: "Hebei", cityNameEN: "Shijiazhuang" },
        "taiyuan": { province: "å±±è¥¿çœ", provinceEN: "Shanxi", cityNameEN: "Taiyuan" },
        "hohhot": { province: "å†…è’™å¤è‡ªæ²»åŒº", provinceEN: "Inner Mongolia", cityNameEN: "Hohhot" },
        "shenyang": { province: "è¾½å®çœ", provinceEN: "Liaoning", cityNameEN: "Shenyang" },
        "changchun": { province: "å‰æ—çœ", provinceEN: "Jilin", cityNameEN: "Changchun" },
        "harbin": { province: "é»‘é¾™æ±Ÿçœ", provinceEN: "Heilongjiang", cityNameEN: "Harbin" },
        "nanjing": { province: "æ±Ÿè‹çœ", provinceEN: "Jiangsu", cityNameEN: "Nanjing" },
        "hangzhou": { province: "æµ™æ±Ÿçœ", provinceEN: "Zhejiang", cityNameEN: "Hangzhou" },
        "hefei": { province: "å®‰å¾½çœ", provinceEN: "Anhui", cityNameEN: "Hefei" },
        "fuzhou": { province: "ç¦å»ºçœ", provinceEN: "Fujian", cityNameEN: "Fuzhou" },
        "nanchang": { province: "æ±Ÿè¥¿çœ", provinceEN: "Jiangxi", cityNameEN: "Nanchang" },
        "jinan": { province: "å±±ä¸œçœ", provinceEN: "Shandong", cityNameEN: "Jinan" },
        "zhengzhou": { province: "æ²³å—çœ", provinceEN: "Henan", cityNameEN: "Zhengzhou" },
        "wuhan": { province: "æ¹–åŒ—çœ", provinceEN: "Hubei", cityNameEN: "Wuhan" },
        "changsha": { province: "æ¹–å—çœ", provinceEN: "Hunan", cityNameEN: "Changsha" },
        "guangzhou": { province: "å¹¿ä¸œçœ", provinceEN: "Guangdong", cityNameEN: "Guangzhou" },
        "nanning": { province: "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº", provinceEN: "Guangxi", cityNameEN: "Nanning" },
        "haikou": { province: "æµ·å—çœ", provinceEN: "Hainan", cityNameEN: "Haikou" },
        "chengdu": { province: "å››å·çœ", provinceEN: "Sichuan", cityNameEN: "Chengdu" },
        "guiyang": { province: "è´µå·çœ", provinceEN: "Guizhou", cityNameEN: "Guiyang" },
        "kunming": { province: "äº‘å—çœ", provinceEN: "Yunnan", cityNameEN: "Kunming" },
        "lhasa": { province: "è¥¿è—è‡ªæ²»åŒº", provinceEN: "Tibet", cityNameEN: "Lhasa" },
        "xi'an": { province: "é™•è¥¿çœ", provinceEN: "Shaanxi", cityNameEN: "Xi'an" },
        "lanzhou": { province: "ç”˜è‚ƒçœ", provinceEN: "Gansu", cityNameEN: "Lanzhou" },
        "xining": { province: "é’æµ·çœ", provinceEN: "Qinghai", cityNameEN: "Xining" },
        "yinchuan": { province: "å®å¤å›æ—è‡ªæ²»åŒº", provinceEN: "Ningxia", cityNameEN: "Yinchuan" },
        "urumchi": { province: "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº", provinceEN: "Xinjiang", cityNameEN: "Urumqi" },
        "taiwan": { province: "å°æ¹¾çœ", provinceEN: "Taiwan", cityNameEN: "Taiwan" },
        "macao": { province: "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº", provinceEN: "Macao", cityNameEN: "Macao"},
        "hong kong": { province: "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº", provinceEN: "Hong Kong", cityNameEN: "Hong Kong"}
    };

    let myChart = null;
    let allYears = [];
    let currentYear = null;

    // åˆå§‹åŒ–å›¾è¡¨
    function initChart() {
        const chartDom = document.getElementById('priceMap');
        myChart = echarts.init(chartDom);
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        myChart.showLoading({
            text: 'Loading map data...',
            color: '#667eea'
        });
    }

    // åŠ è½½å¹´ä»½åˆ—è¡¨
    async function loadYears() {
        try {
            const response = await fetch('/api/map_data');
            const result = await response.json();
            
            if (result.success) {
                allYears = result.years;
                currentYear = result.year;
                
                // å¡«å……å¹´ä»½ä¸‹æ‹‰æ¡†
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '';
                allYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                });
                
                // åŠ è½½å½“å‰å¹´ä»½æ•°æ®
                await loadMapData(currentYear);
            }
        } catch (error) {
            console.error('Failed to load data:', error);
            alert('Failed to load data. Please refresh the page.');
        }
    }

    // åŠ è½½åœ°å›¾æ•°æ®
    async function loadMapData(year) {
        try {
            const response = await fetch(`/api/map_data?year=${year}`);
            const result = await response.json();
            
            if (result.success) {
                // å°†è‹±æ–‡åŸå¸‚æ•°æ®è½¬æ¢ä¸ºçœä»½æ•°æ®
                const provinceData = [];
                const cityDisplayData = [];
                
                result.data.forEach(item => {
                    const cityNameEN = item.name.toLowerCase();
                    const mapping = cityToProvince[cityNameEN];
                    
                    if (mapping) {
                        // ç”¨äºåœ°å›¾æ˜¾ç¤ºï¼ˆå¿…é¡»ä½¿ç”¨ä¸­æ–‡çœåï¼‰
                        provinceData.push({
                            name: mapping.province,  // EChartséœ€è¦ä¸­æ–‡çœå
                            value: item.value,
                            cityNameEN: mapping.cityNameEN,  // è‹±æ–‡åŸå¸‚å
                            provinceEN: mapping.provinceEN,  // è‹±æ–‡çœå
                            changeRate: item.changeRate || 0
                        });
                        
                        // ç”¨äºç»Ÿè®¡å’Œæ’åæ˜¾ç¤ºï¼ˆçº¯è‹±æ–‡ï¼‰
                        cityDisplayData.push({
                            name: mapping.cityNameEN,
                            value: item.value,
                            changeRate: item.changeRate || 0
                        });
                    } else {
                        console.warn('Mapping not found for:', cityNameEN);
                    }
                });
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStats(cityDisplayData);
                
                // æ›´æ–°TOP10åˆ—è¡¨
                updateTopCities(cityDisplayData);
                
                // æ¸²æŸ“åœ°å›¾
                renderMap(provinceData, year);
            } else {
                alert('Failed to load map data: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Failed to load map data:', error);
            alert('Failed to load map data. Please check your internet connection.');
        }
    }

    // æ›´æ–°ç»Ÿè®¡æ•°æ®
    function updateStats(data) {
        if (data.length === 0) return;
        
        const prices = data.map(item => item.value);
        const maxPrice = Math.max(...prices);
        const minPrice = Math.min(...prices);
        const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
        
        document.getElementById('maxPrice').textContent = 'Â¥' + maxPrice.toLocaleString();
        document.getElementById('minPrice').textContent = 'Â¥' + minPrice.toLocaleString();
        document.getElementById('avgPrice').textContent = 'Â¥' + Math.round(avgPrice).toLocaleString();
        document.getElementById('totalCities').textContent = data.length;
    }

    // æ›´æ–°TOP10åŸå¸‚åˆ—è¡¨
    function updateTopCities(data) {
        const sorted = [...data].sort((a, b) => b.value - a.value).slice(0, 10);
        const listHtml = sorted.map((item, index) => `
            <div class="city-rank-item">
                <span>${index + 1}. ${item.name}</span>
                <strong>Â¥${item.value.toLocaleString()}</strong>
            </div>
        `).join('');
        
        document.getElementById('topCitiesList').innerHTML = listHtml;
    }

    // æ¸²æŸ“åœ°å›¾
    function renderMap(data, year) {
        myChart.hideLoading();
        
        const option = {
            title: {
                text: `China Housing Price Distribution Heat Map (${year})`,
                left: 'center',
                top: 20,
                textStyle: {
                    fontSize: 24,
                    fontWeight: 'bold',
                    color: '#333'
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.data && params.data.value) {
                        const cityName = params.data.cityNameEN;
                        const provinceName = params.data.provinceEN;
                        const price = params.data.value;
                        const changeRate = params.data.changeRate || 0;
                        const changeColor = changeRate >= 0 ? '#ff4444' : '#00cc00';
                        const changeSign = changeRate > 0 ? '+' : '';
                        
                        return `
                            <div style="padding: 10px;">
                                <strong style="font-size: 16px;">${cityName}, ${provinceName}</strong><br/>
                                <span style="color: #667eea;">ğŸ’° Price:</span> Â¥${price.toLocaleString()}/mÂ²<br/>
                                <span style="color: ${changeColor};">ğŸ“ˆ YoY Change:</span> ${changeSign}${changeRate}%
                            </div>
                        `;
                    } else {
                        return `<div style="padding: 10px;">${params.name}<br/>No data available</div>`;
                    }
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#667eea',
                borderWidth: 2,
                textStyle: {
                    color: '#333'
                }
            },
            visualMap: {
                show: true,
                left: 'left',
                bottom: 'bottom',
                type: 'piecewise',
                pieces: [
                    {min: 100000, label: 'â‰¥ Â¥100,000', color: '#67001f'},
                    {min: 50000, max: 99999, label: 'Â¥50,000 - Â¥99,999', color: '#b2182b'},
                    {min: 30000, max: 49999, label: 'Â¥30,000 - Â¥49,999', color: '#d6604d'},
                    {min: 20000, max: 29999, label: 'Â¥20,000 - Â¥29,999', color: '#f4a582'},
                    {min: 15000, max: 19999, label: 'Â¥15,000 - Â¥19,999', color: '#fddbc7'},
                    {min: 10000, max: 14999, label: 'Â¥10,000 - Â¥14,999', color: '#d1e5f0'},
                    {min: 8000, max: 9999, label: 'Â¥8,000 - Â¥9,999', color: '#92c5de'},
                    {min: 6000, max: 7999, label: 'Â¥6,000 - Â¥7,999', color: '#4393c3'},
                    {min: 4000, max: 5999, label: 'Â¥4,000 - Â¥5,999', color: '#2166ac'},
                    {max: 3999, label: '< Â¥4,000', color: '#053061'}
                ],
                textStyle: {
                    color: '#333',
                    fontSize: 12
                }
            },
            series: [
                {
                    name: 'Housing Price',
                    type: 'map',
                    map: 'china',
                    roam: true,
                    emphasis: {
                        label: {
                            show: false  // æ‚¬åœæ—¶ä¹Ÿä¸æ˜¾ç¤ºçœå
                        },
                        itemStyle: {
                            areaColor: '#667eea',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    },
                    itemStyle: {
                        areaColor: '#eee',
                        borderColor: '#999',
                        borderWidth: 0.5
                    },
                    label: {
                        show: false  // ä¸æ˜¾ç¤ºçœå
                    },
                    data: data
                }
            ]
        };
        
        myChart.setOption(option, true);
    }

    // å¹´ä»½é€‰æ‹©äº‹ä»¶
    document.getElementById('yearSelect').addEventListener('change', function(e) {
        const selectedYear = parseInt(e.target.value);
        if (selectedYear) {
            loadMapData(selectedYear);
        }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
        initChart();
        
        // æ³¨å†Œä¸­å›½åœ°å›¾
        try {
            const response = await fetch('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json');
            const chinaJson = await response.json();
            echarts.registerMap('china', chinaJson);
            
            // åŠ è½½å¹´ä»½å’Œæ•°æ®
            await loadYears();
        } catch (error) {
            console.error('Failed to load map:', error);
            myChart.hideLoading();
            alert('Failed to load map. Please check your internet connection.');
        }
    });

    // å“åº”å¼è°ƒæ•´
    window.addEventListener('resize', function() {
        if (myChart) {
            myChart.resize();
        }
    });
</script>
{% endblock %}